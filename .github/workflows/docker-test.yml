name: Docker Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  docker-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create environment file
      run: |
        echo "NODE_ENV=test" >> .env
        echo "PORT=5000" >> .env
        echo "JWT_SECRET=test-jwt-secret-key" >> .env
        echo "SESSION_SECRET=test-session-secret-key" >> .env
        echo "MONGODB_URI=mongodb://admin:password123@mongodb:27017/test_db?authSource=admin" >> .env
        echo "CLIENT_URL=http://localhost:3000" >> .env
        
    - name: Build and start services
      run: |
        docker-compose -f docker-compose.yml up -d --build
        
    - name: Wait for services to be healthy
      run: |
        echo "Waiting for services to start..."
        sleep 60
        
    - name: Test server health
      run: |
        curl -f http://localhost:5000/api/health || exit 1
        
    - name: Test client accessibility
      run: |
        curl -f http://localhost:3000 || exit 1
        
    - name: Run integration tests
      run: |
        docker-compose exec -T server npm test
        
    - name: Show logs on failure
      if: failure()
      run: |
        docker-compose logs
        
    - name: Cleanup
      if: always()
      run: |
        docker-compose down -v